<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>保质期计算器</title>

<!-- Bootstrap & icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
  body { background:#f5f7fb; }
  .card { border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.05); border:none; }
  .nav-pills .nav-link.active { background:#4e73df; color:#fff; }
  .info-box { background:#eef4ff; border-left:4px solid #4e73df; padding:12px; border-radius:8px; color:#1f4ed8; }
  .record-card { background:#fff; border-radius:10px; padding:14px; margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,0.03); }
  .record-meta { color:#6c757d; font-size:0.95rem; }
  .btn-icon { width:36px; height:36px; padding:6px; display:inline-flex; align-items:center; justify-content:center; }
  .small-muted { color:#708090; font-size:0.92rem; }
</style>
</head>
<body>
<div class="container py-3" style="max-width:780px;">

  <!-- Header -->
  <div class="d-flex align-items-center mb-3">
    <i class="bi bi-calendar-check fs-4 me-2"></i>
    <h5 class="mb-0">保质期计算器</h5>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-pills mb-3">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tabCalc"><i class="bi bi-calculator me-1"></i> 计算器</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabSaved"><i class="bi bi-save me-1"></i> 保存结果 <span class="badge bg-primary ms-1" id="countBadge">0</span></button>
    </li>
  </ul>

  <div class="tab-content">

    <!-- 计算器 Tab -->
    <div class="tab-pane fade show active" id="tabCalc">
      <div class="card mb-3">
        <div class="card-body">

          <h6 class="mb-3"><i class="bi bi-input-cursor-text me-1"></i> 输入信息</h6>

          <div class="mb-3">
            <label class="form-label">商品名称（可选）</label>
            <input id="productName" class="form-control" placeholder="例如：牛奶、饼干">
          </div>

          <div class="mb-3">
            <label class="form-label">生产日期</label>
            <div class="input-group">
              <input id="productionDate" class="form-control" placeholder="YYYY-MM-DD" maxlength="10" />
              <button id="clearDateBtn" class="btn btn-outline-secondary" type="button" title="清空生产日期">✕</button>
            </div>
            <div class="form-text">请输入 YYYY-MM-DD，输入数字会自动补 “-”。</div>
          </div>

          <div class="mb-3">
            <label class="form-label">保质期时长</label>
            <input id="shelfValue" type="number" class="form-control" placeholder="例如：30">
          </div>

          <div class="mb-3">
            <label class="form-label">时间单位</label>
            <select id="shelfUnit" class="form-select">
              <option value="days">天</option>
              <option value="months">月</option>
              <option value="years">年</option>
            </select>
          </div>

          <div class="d-grid gap-2">
            <button id="calcBtn" class="btn btn-primary">计算到期日</button>
            <button id="resetBtn" class="btn btn-light">重置</button>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h6 class="mb-2"><i class="bi bi-calculator-fill me-1"></i> 计算结果</h6>
          <div id="resultBox" class="info-box">请输入生产日期和保质期信息，然后点击“计算到期日”。</div>
        </div>
      </div>
    </div>

    <!-- 保存结果 Tab -->
    <div class="tab-pane fade" id="tabSaved">
      <div class="card mb-3">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <i class="bi bi-archive me-2"></i>
            <h6 class="mb-0">已保存的计算结果</h6>
          </div>
          <div class="d-flex gap-2">
            <button id="deleteSelectedBtn" class="btn btn-outline-danger btn-sm">删除选中</button>
            <button id="clearAllBtn" class="btn btn-outline-danger btn-sm">清空全部</button>
            <button id="exportBtn" class="btn btn-success btn-sm"><i class="bi bi-file-earmark-excel me-1"></i> 导出所选</button>
          </div>
        </div>
      </div>

      <!-- 选择全选 -->
      <div class="mb-2 d-flex align-items-center">
        <input type="checkbox" id="selectAll" class="form-check-input me-2">
        <label for="selectAll" class="form-check-label small-muted">全选（用于导出或删除）</label>
      </div>

      <!-- 列表容器 -->
      <div id="savedList"></div>

    </div>

  </div>

  <p class="text-center text-muted small mt-4">保质期计算器 © 2026</p>
</div>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* --------- utils --------- */
function formatNowSlash() {
  const d = new Date();
  const Y = d.getFullYear();
  const M = d.getMonth()+1;
  const D = d.getDate();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `${Y}/${M}/${D} ${hh}:${mm}:${ss}`;
}

function pad2(n){ return String(n).padStart(2,'0'); }

/* --------- storage --------- */
let records = JSON.parse(localStorage.getItem('expiryRecords') || '[]');
const updateStorage = ()=> {
  localStorage.setItem('expiryRecords', JSON.stringify(records));
  countBadge.innerText = records.length;
};

/* ---------- elements ---------- */
const productionDate = document.getElementById('productionDate');
const clearDateBtn = document.getElementById('clearDateBtn');
const productName = document.getElementById('productName');
const shelfValue = document.getElementById('shelfValue');
const shelfUnit = document.getElementById('shelfUnit');
const calcBtn = document.getElementById('calcBtn');
const resetBtn = document.getElementById('resetBtn');
const resultBox = document.getElementById('resultBox');

const savedList = document.getElementById('savedList');
const countBadge = document.getElementById('countBadge');
const selectAll = document.getElementById('selectAll');
const exportBtn = document.getElementById('exportBtn');
const clearAllBtn = document.getElementById('clearAllBtn');
const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

/* init count */
countBadge.innerText = records.length;

/* --------- 输入自动格式化 YYYY-MM-DD --------- */
productionDate.addEventListener('input', function(){
  let raw = this.value.replace(/\D/g,'');
  if (raw.length > 4) raw = raw.slice(0,4) + '-' + raw.slice(4);
  if (raw.length > 7) raw = raw.slice(0,7) + '-' + raw.slice(7);
  this.value = raw.slice(0,10);
});
clearDateBtn.addEventListener('click', ()=> productionDate.value = '');
resetBtn.addEventListener('click', ()=>{
  productName.value=''; productionDate.value=''; shelfValue.value=''; shelfUnit.value='days';
  resultBox.innerHTML = '请输入生产日期和保质期信息，然后点击“计算到期日”。';
});

/* --------- 状态判断函数（代码内使用） --------- */
/* 返回 {statusText, badgeClass, diffDays} */
function judgeStatus(expDate){
  const today = new Date(); today.setHours(0,0,0,0);
  const exp = new Date(expDate); exp.setHours(0,0,0,0);
  const diff = Math.floor((exp - today)/86400000); // expiration - today
  let statusText = '', badgeClass = '';
  if (diff < 0) {
    statusText = '已过期';
    badgeClass = 'bg-danger';
  } else if (diff <= 7) {
    statusText = '即将过期';
    badgeClass = 'bg-warning text-dark';
  } else if (diff <= 15) {
    statusText = '临期';
    badgeClass = 'bg-warning text-dark';
  } else {
    statusText = '未过期';
    badgeClass = 'bg-success';
  }
  return { statusText, badgeClass, diffDays: diff };
}

/* --------- 计算函数 --------- */
calcBtn.addEventListener('click', ()=>{
  const name = productName.value.trim() || '（未命名）';
  const prod = productionDate.value.trim();
  const val = parseInt(shelfValue.value);
  const unit = shelfUnit.value;
  if (!prod || !val && val !== 0) { alert('请填写生产日期和保质期时长'); return; }

  // parse prod date
  const base = new Date(prod);
  if (isNaN(base)) { alert('生产日期格式不正确'); return; }

  const exp = new Date(base);
  if (unit === 'days') exp.setDate(exp.getDate() + val);
  if (unit === 'months') exp.setMonth(exp.getMonth() + val);
  if (unit === 'years') exp.setFullYear(exp.getFullYear() + val);

  const expStr = `${exp.getFullYear()}-${pad2(exp.getMonth()+1)}-${pad2(exp.getDate())}`;
  const lifeText = `${val}${ (unit==='days'?' 天':unit==='months'?' 月':' 年') }`;

  const j = judgeStatus(expStr);

  // render result (和你要求的结构一致)
  resultBox.innerHTML = `
    <div class="record-card">
      <div class="mb-2 small-muted">计算结果</div>

      <div class="mb-2">
        <div class="text-muted" style="font-size:0.92rem">到期日期</div>
        <div class="fs-5 fw-bold">${expStr}</div>
      </div>

      <div class="record-meta mb-1">商品名称：${name}</div>
      <div class="record-meta mb-1">生产日期：${prod} ｜ 保质期：${lifeText}</div>
      <div class="record-meta mb-1">剩余天数：${j.diffDays} 天</div>

      <div class="mt-2">状态： <span class="badge ${j.badgeClass}">${j.statusText}</span></div>

      <div class="mt-3">
        <button id="saveBtn" class="btn btn-sm btn-outline-primary">保存结果</button>
      </div>
    </div>
  `;

  // attach save handler
  document.getElementById('saveBtn').onclick = function(){
    const rec = {
      name,
      productionDate: prod,
      shelfLife: lifeText,
      expirationDate: expStr,
      diffDays: j.diffDays,
      status: j.statusText,
      savedAt: formatNowSlash()
    };
    records.push(rec);
    updateStorage();
    renderSavedList();
    // switch to saved tab
    const savedTabBtn = document.querySelector('[data-bs-target="#tabSaved"]');
    if (savedTabBtn) savedTabBtn.click();
    alert('已保存到结果列表');
  };
});

/* --------- render saved list in desired layout --------- */
function renderSavedList(){
  savedList.innerHTML = '';
  if (records.length === 0) {
    savedList.innerHTML = `<div class="alert alert-secondary">暂无已保存记录。</div>`;
    return;
  }

  records.forEach((r, idx)=>{
    // compute status again (ensure badge class kept consistent if time passed)
    const j = judgeStatus(r.expirationDate);
    // update status fields in data (keep status sync)
    r.status = j.statusText;
    r.diffDays = j.diffDays;
    // container
    const wrap = document.createElement('div');
    wrap.className = 'record-card d-flex align-items-start';
    // left: checkbox
    const left = document.createElement('div');
    left.style.marginRight = '12px';
    left.innerHTML = `<input type="checkbox" class="form-check-input row-check" data-idx="${idx}">`;
    // center: content
    const center = document.createElement('div');
    center.style.flex = '1';
    center.innerHTML = `
      <div class="fw-bold mb-1">${escapeHtml(r.name)}</div>
      <div class="record-meta mb-1">生产日期：${r.productionDate} ｜ 保质期：${r.shelfLife}</div>
      <div class="mb-1">到期日：<b>${r.expirationDate}</b> <span class="badge ${j.badgeClass} ms-2">${j.statusText}</span></div>
      <div class="small-muted">保存时间：${r.savedAt}</div>
    `;
    // right: actions
    const right = document.createElement('div');
    right.className = 'd-flex flex-column align-items-end ms-3';
    right.innerHTML = `
      <button class="btn btn-icon btn-sm btn-outline-danger mb-2 delete-single" title="删除" data-idx="${idx}"><i class="bi bi-trash"></i></button>
    `;
    wrap.appendChild(left);
    wrap.appendChild(center);
    wrap.appendChild(right);
    savedList.appendChild(wrap);
  });

  // hook delete buttons & checkboxes
  document.querySelectorAll('.delete-single').forEach(btn=>{
    btn.onclick = function(){
      const i = parseInt(this.getAttribute('data-idx'));
      if (!isNaN(i) && confirm('确认删除该条记录？')) {
        records.splice(i,1);
        updateStorage();
        renderSavedList();
      }
    };
  });

  // when rendered, ensure selectAll unchecked
  selectAll.checked = false;
}

/* --------- select all logic --------- */
selectAll.addEventListener('change', function(){
  const checked = this.checked;
  document.querySelectorAll('.row-check').forEach(cb => cb.checked = checked);
});

/* --------- delete selected --------- */
deleteSelectedBtn.addEventListener('click', ()=>{
  const checkedEls = Array.from(document.querySelectorAll('.row-check')).filter(cb => cb.checked);
  if (checkedEls.length === 0) { alert('请先选中要删除的记录'); return; }
  if (!confirm(`确认删除 ${checkedEls.length} 条选中记录？`)) return;
  // collect indexes descending to remove safely
  const idxs = checkedEls.map(cb => parseInt(cb.getAttribute('data-idx'))).sort((a,b)=>b-a);
  idxs.forEach(i => { if (!isNaN(i)) records.splice(i,1); });
  updateStorage();
  renderSavedList();
});

/* --------- clear all --------- */
clearAllBtn.addEventListener('click', ()=>{
  if (!confirm('确认清空所有已保存记录？')) return;
  records = [];
  updateStorage();
  renderSavedList();
});

/* --------- export selected --------- */
exportBtn.addEventListener('click', ()=>{
  const checkedEls = Array.from(document.querySelectorAll('.row-check')).filter(cb => cb.checked);
  let toExport = [];
  if (checkedEls.length === 0) {
    // 没选中则导出全部
    toExport = records.slice();
    if (toExport.length === 0) { alert('没有可导出的记录'); return; }
  } else {
    // 按选中顺序
    const idxs = checkedEls.map(cb => parseInt(cb.getAttribute('data-idx'))).sort((a,b)=>a-b);
    idxs.forEach(i => { if (!isNaN(i) && records[i]) toExport.push(records[i]); });
  }

  // build sheet data
  const sheet = [
    ['商品名称','生产日期','保质期','到期日','状态','剩余天数','保存时间']
  ];
  toExport.forEach(r => {
    sheet.push([ r.name, r.productionDate, r.shelfLife, r.expirationDate, r.status, r.diffDays, r.savedAt ]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(sheet);
  XLSX.utils.book_append_sheet(wb, ws, '保质期结果');
  XLSX.writeFile(wb, `expiry_export_${(new Date()).getTime()}.xlsx`);
});

/* --------- XSS-safe text escape for display --------- */
function escapeHtml(s){
  if (!s && s !== 0) return '';
  return String(s).replace(/[&<>"']/g, function(m){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
  });
}

/* initial render */
renderSavedList();
updateStorage();

</script>
</body>
</html>